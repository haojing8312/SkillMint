# Milestone 1 æ”¶å°¾åŠŸèƒ½è®¾è®¡

> **Date**: 2026-02-26
> **Status**: Approved
> **Author**: Claude Sonnet 4.6

---

## æ¨¡å— 1: File Upload æ”¯æŒ

### ç›®æ ‡

å…è®¸ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ï¼Œæ–‡ä»¶å†…å®¹å°†å‘é€ç»™ LLMã€‚

### å‚è€ƒå®ç°

å‚è€ƒ Open Claude Cowork çš„å®ç°æ–¹å¼ã€‚

### UI/UX è®¾è®¡

**é™„ä»¶æŒ‰é’®**ï¼š
- ä½ç½®ï¼šChatView è¾“å…¥åŒºå·¥å…·æ ï¼ˆå‘é€æŒ‰é’®å·¦ä¾§ï¼‰
- å›¾æ ‡ï¼šğŸ“ï¼ˆå›å½¢é’ˆï¼‰
- æ ·å¼ï¼šä¸ç°æœ‰å·¥å…·æ æŒ‰é’®ä¸€è‡´

**æ–‡ä»¶é€‰æ‹©**ï¼š
- è§¦å‘ï¼šç‚¹å‡»é™„ä»¶æŒ‰é’® â†’ æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
- å¤šé€‰ï¼šæ”¯æŒ `multiple` å±æ€§
- é™åˆ¶ï¼šæœ€å¤š 5 ä¸ªæ–‡ä»¶

**é™„ä»¶åˆ—è¡¨å±•ç¤º**ï¼š
- ä½ç½®ï¼šè¾“å…¥æ¡†ä¸Šæ–¹
- æ˜¾ç¤ºï¼šæ–‡ä»¶å + æ–‡ä»¶å¤§å° + åˆ é™¤æŒ‰é’®
- æ ·å¼ï¼šæµ…è‰²èƒŒæ™¯è¯ä¸¸æ ‡ç­¾

**å¤§æ–‡ä»¶å¤„ç†**ï¼š
- é™åˆ¶ï¼šå•æ–‡ä»¶ â‰¤ 5MB
- è¶…å‡ºæç¤ºï¼š`alert('å•ä¸ªæ–‡ä»¶ä¸èƒ½è¶…è¿‡ 5MB')`
- è¯»å–æ–¹å¼ï¼šæ–‡æœ¬æ–‡ä»¶ â†’ æ–‡æœ¬å†…å®¹ï¼Œå›¾ç‰‡ â†’ base64

### æŠ€æœ¯å®ç°

**å‰ç«¯ (ChatView.tsx)**ï¼š
```tsx
// çŠ¶æ€
const [attachedFiles, setAttachedFiles] = useState<FileAttachment[]>([]);

// æ–‡ä»¶é€‰æ‹©å¤„ç†
const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const files = Array.from(e.target.files || []);
  // éªŒè¯æ•°é‡å’Œå¤§å°
  // è¯»å–æ–‡ä»¶å†…å®¹
  // æ›´æ–°çŠ¶æ€
};

// å‘é€æ—¶é™„åŠ æ–‡ä»¶å†…å®¹
const content = files.length > 0
  ? `${message}\n\n---\n\né™„ä»¶æ–‡ä»¶ï¼š\n${files.map(f => `## ${f.name}\n\`\`\`\n${f.content}\n\`\`\``).join('\n\n')}`
  : message;
```

**æ¶ˆæ¯æ ¼å¼**ï¼š
```json
{
  "role": "user",
  "content": "ç”¨æˆ·æ¶ˆæ¯\n\n---\n\né™„ä»¶æ–‡ä»¶ï¼š\n## filename.ts\n```\næ–‡ä»¶å†…å®¹\n```"
}
```

### é™åˆ¶

| é™åˆ¶é¡¹ | å€¼ |
|--------|-----|
| æœ€å¤§æ–‡ä»¶æ•° | 5 |
| å•æ–‡ä»¶å¤§å° | 5MB |
| æ”¯æŒç±»å‹ | æ‰€æœ‰ï¼ˆæ–‡æœ¬ä¼˜å…ˆï¼‰ |

---

## æ¨¡å— 2: Secure Workspace é…ç½®

### ç›®æ ‡

ä¸ºæ¯ä¸ªä¼šè¯é…ç½®ç‹¬ç«‹çš„å·¥ä½œç©ºé—´ç›®å½•ï¼ŒAgent åªèƒ½åœ¨è¯¥ç›®å½•ä¸‹æ“ä½œæ–‡ä»¶ã€‚

### æ•°æ®æ¨¡å‹

**Sessions è¡¨å˜æ›´**ï¼š
```sql
ALTER TABLE sessions ADD COLUMN workspace_path TEXT;
```

**é»˜è®¤å€¼**ï¼š`C:\Users\<ç”¨æˆ·å>\.skillmint\projects`

### UI/UX è®¾è®¡

**å·¥ä½œç©ºé—´æ˜¾ç¤º**ï¼š
- ä½ç½®ï¼šChatView å¤´éƒ¨ï¼ˆæ¨¡å‹åç§°å³ä¾§ï¼‰
- æ ·å¼ï¼šç‚¹å‡»æŒ‰é’®ï¼Œæ˜¾ç¤ºå½“å‰è·¯å¾„
- å›¾æ ‡ï¼šğŸ“ + è·¯å¾„æ–‡å­—

**ä¸‹æ‹‰åˆ—è¡¨**ï¼š
- æœ€è¿‘ä½¿ç”¨ï¼šæ˜¾ç¤ºæœ€è¿‘ 5 ä¸ªå·¥ä½œç›®å½•
- é€‰æ‹©æ–°æ–‡ä»¶å¤¹ï¼šæ‰“å¼€ç›®å½•é€‰æ‹©å™¨
- æ ·å¼ï¼šä¸‹æ‹‰èœå•ï¼Œæµ…è‰²ä¸»é¢˜

**ç›®å½•é€‰æ‹©å™¨**ï¼š
- APIï¼šTauri `dialog::open({ directory: true })`
- é€‰æ‹©åï¼šæ›´æ–°å½“å‰ä¼šè¯çš„ `workspace_path`

### æƒé™æ£€æŸ¥

**å·¥å…·æ‰§è¡Œå‰éªŒè¯**ï¼š
```rust
fn validate_workspace(path: &Path, workspace: &Path) -> bool {
    path.starts_with(workspace)
}
```

**å—é™å·¥å…·**ï¼š
- `read_file`
- `write_file`
- `list_dir`
- `glob`
- `grep`
- `file_stat`
- `file_delete`
- `file_move`
- `file_copy`

### è¡Œä¸º

1. **æ–°å»ºå¯¹è¯**ï¼šç»§æ‰¿ä¸Šä¸€ä¸ªå¯¹è¯çš„å·¥ä½œç©ºé—´
2. **é¦–æ¬¡ä½¿ç”¨**ï¼šä½¿ç”¨é»˜è®¤è·¯å¾„ `C:\Users\<ç”¨æˆ·å>\.skillmint\projects`
3. **ç›®å½•ä¸å­˜åœ¨**ï¼šè‡ªåŠ¨åˆ›å»º
4. **è¶Šæƒè®¿é—®**ï¼šè¿”å›é”™è¯¯æç¤º

---

## æ¨¡å— 3: æ‰‹åŠ¨è§¦å‘å‹ç¼©

### ç›®æ ‡

å…è®¸ç”¨æˆ·ä¸»åŠ¨è§¦å‘ä¸Šä¸‹æ–‡å‹ç¼©ï¼Œé‡Šæ”¾ token é¢„ç®—ã€‚

### è§¦å‘æ–¹å¼

**æ–¹å¼ 1ï¼šæŒ‰é’®è§¦å‘**
- ä½ç½®ï¼šChatView è¾“å…¥åŒºå·¥å…·æ 
- å›¾æ ‡ï¼šğŸ“¦ï¼ˆæ‰“åŒ…/å‹ç¼©ï¼‰
- çŠ¶æ€ï¼šå‹ç¼©è¿›è¡Œæ—¶æ˜¾ç¤º loading

**æ–¹å¼ 2ï¼šå‘½ä»¤è§¦å‘**
- å‘½ä»¤ï¼š`/compact`
- å¤„ç†ï¼šè¯†åˆ«å‘½ä»¤ â†’ ç§»é™¤å‘½ä»¤æ–‡æœ¬ â†’ è§¦å‘å‹ç¼©

### æ‰§è¡Œæµç¨‹

```rust
// 1. ä¼°ç®—å½“å‰ token æ•°
let estimated_tokens = estimate_tokens(&messages);

// 2. ä¿å­˜å®Œæ•´è®°å½•åˆ°ç£ç›˜
let transcript_path = save_transcript(&transcript_dir, &session_id, &messages)?;

// 3. è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦
let compacted = auto_compact(
    &api_format,
    &base_url,
    &api_key,
    &model,
    &messages,
    &transcript_path,
).await?;

// 4. æ›´æ–°ä¼šè¯æ¶ˆæ¯
update_session_messages(&session_id, &compacted)?;

Ok(CompactionResult {
    original_tokens: estimated_tokens,
    new_tokens: estimate_tokens(&compacted),
    transcript_path,
    summary: summary_text,
})
```

### UI å±•ç¤º

**å‹ç¼©è¿›è¡Œä¸­**ï¼š
- è¾“å…¥æ¡†æ˜¾ç¤ºï¼š"æ­£åœ¨å‹ç¼©ä¸Šä¸‹æ–‡..."
- æŒ‰é’®æ˜¾ç¤º loading çŠ¶æ€
- ç¦ç”¨è¾“å…¥

**å‹ç¼©å®Œæˆå**ï¼š
- æ˜¾ç¤º token èŠ‚çœä¿¡æ¯ï¼š`"å·²å‹ç¼©ä¸Šä¸‹æ–‡ï¼š50,000 â†’ 12,000 tokens"`
- æ˜¾ç¤ºæ‘˜è¦å†…å®¹ï¼ˆä½œä¸º assistant æ¶ˆæ¯æ’å…¥ï¼‰

**ç¤ºä¾‹å±•ç¤º**ï¼š
```
[ç”¨æˆ·]: /compact

[ç³»ç»Ÿ]: ğŸ“¦ ä¸Šä¸‹æ–‡å·²å‹ç¼©ï¼š50,000 â†’ 12,000 tokens

[åŠ©æ‰‹]: ## å¯¹è¯æ‘˜è¦
### ç”¨æˆ·è¯·æ±‚
ç”¨æˆ·å¸Œæœ›å®ç°ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½...

### å·²å®Œæˆ
- åˆ†æäº†é¡¹ç›®ç»“æ„
- è®¾è®¡äº† UI æ–¹æ¡ˆ

### å¾…åŠ
- å®ç°å‰ç«¯ç»„ä»¶
- æ·»åŠ åç«¯ API
```

---

## å®æ–½é¡ºåº

1. **File Upload** - æœ€ç®€å•ï¼Œå…ˆå®ç°
2. **Secure Workspace** - éœ€è¦æ•°æ®åº“å˜æ›´
3. **æ‰‹åŠ¨å‹ç¼©** - éœ€è¦åç«¯ LLM è°ƒç”¨

---

## ç›¸å…³æ–‡ä»¶

- `apps/runtime/src/components/ChatView.tsx` - UI ä¿®æ”¹
- `apps/runtime/src-tauri/src/db.rs` - æ•°æ®åº“å˜æ›´
- `apps/runtime/src-tauri/src/agent/permissions.rs` - æƒé™æ£€æŸ¥
- `apps/runtime/src-tauri/src/agent/compactor.rs` - å‹ç¼©åŠŸèƒ½
- `apps/runtime/src-tauri/src/commands/chat.rs` - ä¼šè¯ç®¡ç†
